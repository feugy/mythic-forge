(function(a,b){if(typeof exports==="object"&&a.require){module.exports=b(require("underscore"),require("backbone"))}else{if(typeof define==="function"&&define.amd){define(["underscore","backbone"],function(c,d){return b(c||a._,d||a.Backbone)})}else{b(_,Backbone)}}}(this,function(m,l){var j=/^\?(.*)/,b=/\((.*?)\)/g,o=/(\(\?)?:\w+/g,i=/\*\w+/g,h=/[\-{}\[\]+?.,\\\^$|#\s]/g,k=/(\?.*)$/,a=/^([^\?]*)/,d=/(\?)[\w-]+/i,c=/[\:\*]([^\:\?\/]+)/g,g=/^[#\/]|\s+$/g,f=/\/$/;l.Router.arrayValueSplit="|";var n=function(r,q){if(r==null){if(this._hasPushState||!this._wantsHashChange||q){r=this.location.pathname;var p=this.root.replace(f,"");var s=this.location.search;if(!r.indexOf(p)){r=r.substr(p.length)}if(s){r+=s}}else{r=this.getHash()}}return r.replace(g,"")};m.extend(l.History.prototype,{getFragment:function(q,p){var s=(this._wantsHashChange&&this._wantsPushState&&!this._hasPushState);var r=n.apply(this,arguments);if(q==null&&r==null&&!d.test(r)){r+=this.location.search}else{if(s){r=r.replace(k,"")}}return r},getQueryParameters:function(r,p){r=n.apply(this,arguments);var t=r.replace(a,"");var q=t.match(j);if(q){t=q[1];var s={};e(t,function(u,v){v=v.replace(/\+/g,"%20");v=decodeURIComponent(v);if(!s[u]){s[u]=v}else{if(m.isString(s[u])){s[u]=[s[u],v]}else{s[u].push(v)}}});return s}else{return{}}}});m.extend(l.Router.prototype,{initialize:function(p){this.encodedSplatParts=p&&p.encodedSplatParts},getFragment:function(q,p,r){q=n.apply(this,arguments);if(r){q=q.replace(k,"")}return q},_routeToRegExp:function(q){var r=(i.exec(q)||{index:-1}),p=(o.exec(q)||{index:-1}),t=q.match(c)||[];q=q.replace(h,"\\$&").replace(b,"(?:$1)?").replace(o,function(v,u){return u?v:"([^\\/\\?]+)"}).replace(i,"([^??]*?)");q+="(\\?.*)?";var s=new RegExp("^"+q+"$");if(r.index>=0){if(p>=0){s.splatMatch=r.index-p.index}else{s.splatMatch=-1}}s.paramNames=m.map(t,function(u){return u.substring(1)});s.namedParameters=this.namedParameters;return s},_extractParameters:function(x,v){var r=x.exec(v).slice(1),w={};if(r.length>0&&m.isUndefined(r[r.length-1])){r.splice(r.length-1,1)}var u=r.length&&r[r.length-1]&&r[r.length-1].match(j);if(u){var p=u[1];var t={};if(p){var y=this;e(p,function(z,A){y._setParamValue(z,A,t)})}r[r.length-1]=t;m.extend(w,t)}var q=r.length;if(x.splatMatch&&this.encodedSplatParts){if(x.splatMatch<0){return r}else{q=q-1}}for(var s=0;s<q;s++){if(m.isString(r[s])){r[s]=decodeURIComponent(r[s]);if(x.paramNames&&x.paramNames.length>=s-1){w[x.paramNames[s]]=r[s]}}}return(l.Router.namedParameters||x.namedParameters)?[w]:r},_setParamValue:function(r,u,t){r=r.replace("[]","");var v=r.split(".");var s=t;for(var q=0;q<v.length;q++){var p=v[q];if(q===v.length-1){s[p]=this._decodeParamValue(u,s[p])}else{s=s[p]=s[p]||{}}}},_decodeParamValue:function(s,r){s=s.replace(/\+/g,"%20");var t=l.Router.arrayValueSplit;if(t&&s.indexOf(t)>=0){var p=s.split(t);for(var q=p.length-1;q>=0;q--){if(!p[q]){p.splice(q,1)}else{p[q]=decodeURIComponent(p[q])}}return p}s=decodeURIComponent(s);if(!r){return s}else{if(m.isArray(r)){r.push(s);return r}else{return[r,s]}}},toFragment:function(q,p){if(p){if(!m.isString(p)){p=this._toQueryString(p)}if(p){q+="?"+p}}return q},_toQueryString:function(r,p){var y=l.Router.arrayValueSplit;function t(A){return String(A).replace(y,encodeURIComponent(y))}if(!r){return""}p=p||"";var w="";for(var q in r){var v=r[q];if(m.isString(v)||m.isNumber(v)||m.isBoolean(v)||m.isDate(v)){v=this._toQueryParam(v);if(m.isBoolean(v)||m.isNumber(v)||m.isString(v)||v){w+=(w?"&":"")+this._toQueryParamName(q,p)+"="+t(encodeURIComponent(v))}}else{if(m.isArray(v)){var x="";for(var u=0;u<v.length;u++){var s=this._toQueryParam(v[u]);if(m.isBoolean(s)||s!==null){x+=y+t(s)}}if(x){w+=(w?"&":"")+this._toQueryParamName(q,p)+"="+x}}else{var z=this._toQueryString(v,this._toQueryParamName(q,p,true));if(z){w+=(w?"&":"")+z}}}}return w},_toQueryParamName:function(p,r,q){return(r+p+(q?".":""))},_toQueryParam:function(p){if(m.isNull(p)||m.isUndefined(p)){return null}return p}});function e(r,q){var p=r.split("&");m.each(p,function(t){var s=t.split("=");q(s.shift(),s.join("="))})}}));